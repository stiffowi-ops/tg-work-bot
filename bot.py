import os
import logging
import json
from datetime import datetime, timedelta
from typing import Optional, Dict
import pytz

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    JobQueue,
    MessageHandler,
    filters
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")  # –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
CONFIG_FILE = "bot_config.json"  # –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

ALLOWED_USERS = ["Stiff_OWi", "gshabanov"]  # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã

# –í—Ä–µ–º—è –ø–ª–∞–Ω—ë—Ä–∫–∏ (9:15 –ø–æ –ú–æ—Å–∫–≤–µ)
MEETING_TIME = {"hour": 9, "minute": 15}
TIMEZONE = pytz.timezone("Europe/Moscow")

# –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ø–ª–∞–Ω—ë—Ä–∫–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫=0, —Å—Ä–µ–¥–∞=2, –ø—è—Ç–Ω–∏—Ü–∞=4)
MEETING_DAYS = [0, 2, 4]

# –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–º–µ–Ω—ã –ø–ª–∞–Ω—ë—Ä–∫–∏
CANCELLATION_OPTIONS = [
    "–ü–µ—Ä–µ–Ω–µ—Å—ë–º –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å. –î–∞—Ç–∞ —Ç–∞–∫–∞—è-—Ç–æ",
    "–ü—Ä–∏—á–∏–Ω—É —Å–æ–æ–±—â—É –ø–æ–∑–∂–µ",
    "–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–µ—à–µ–Ω—ã, –ø–ª–∞–Ω—ë—Ä–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞",
    "–ö–ª—é—á–µ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç",
    "–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è, –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –õ–°",
]

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
active_reminder: Optional[Dict] = None


def load_config() -> Dict:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r') as f:
                return json.load(f)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞: {e}")
    return {"chat_id": None}


def save_config(config: Dict) -> None:
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª"""
    try:
        with open(CONFIG_FILE, 'w') as f:
            json.dump(config, f)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞: {e}")


async def send_reminder(context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø–ª–∞–Ω—ë—Ä–∫–µ"""
    global active_reminder

    config = load_config()
    chat_id = config.get("chat_id")

    if not chat_id:
        logger.error("Chat ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        return

    keyboard = [
        [InlineKeyboardButton("–û—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω—ë—Ä–∫—É", callback_data="cancel_meeting")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = (
        "üëã –ö–æ–ª–ª–µ–≥–∏, –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ!\n\n"
        "üìã –ù–∞–ø–æ–º–∏–Ω–∞—é –æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω—ë—Ä–∫–µ –≤ 9:15 –ø–æ –ú–°–ö.\n"
        "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∑–≤–æ–Ω–∫—É!"
    )

    try:
        message = await context.bot.send_message(
            chat_id=chat_id,
            text=message_text,
            reply_markup=reply_markup
        )

        active_reminder = {
            "message_id": message.message_id,
            "chat_id": chat_id,
            "job": getattr(context, "job", None)
        }

        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —á–∞—Ç {chat_id}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")


async def cancel_meeting_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query

    username = query.from_user.username
    if username not in ALLOWED_USERS:
        await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã –ø–ª–∞–Ω—ë—Ä–∫–∏", show_alert=True)
        return

    await query.answer()

    keyboard = [
        [InlineKeyboardButton(option, callback_data=f"reason_{i}")]
        for i, option in enumerate(CANCELLATION_OPTIONS)
    ]

    await query.edit_message_text(
        text="üìù –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –ø–ª–∞–Ω—ë—Ä–∫–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def reason_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    global active_reminder

    query = update.callback_query
    reason_index = int(query.data.split("_")[1])
    reason = CANCELLATION_OPTIONS[reason_index]
    username = query.from_user.username

    if active_reminder and "job" in active_reminder and active_reminder["job"]:
        active_reminder["job"].schedule_removal()
        active_reminder = None

    await query.edit_message_text(
        text=f"‚ùå @{username} –æ—Ç–º–µ–Ω–∏–ª –ø–ª–∞–Ω—ë—Ä–∫—É\n\n–ü—Ä–∏—á–∏–Ω–∞: {reason}"
    )

    logger.info(f"–ü–ª–∞–Ω—ë—Ä–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ @{username} ‚Äî {reason}")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(
        "–ë–æ—Ç –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ø–ª–∞–Ω—ë—Ä–∫–µ –∞–∫—Ç–∏–≤–µ–Ω!\n"
        f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º, —Å—Ä–µ–¥–∞–º –∏ –ø—è—Ç–Ω–∏—Ü–∞–º –≤ "
        f"{MEETING_TIME['hour']:02d}:{MEETING_TIME['minute']:02d} –ø–æ –ú–°–ö.\n\n"
        "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /setchat"
    )


async def set_chat(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.effective_user.username not in ALLOWED_USERS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return

    chat_id = update.effective_chat.id
    chat_title = update.effective_chat.title or "–ª–∏—á–Ω—ã–π —á–∞—Ç"

    config = load_config()
    config["chat_id"] = chat_id
    save_config(config)

    await update.message.reply_text(
        f"‚úÖ –ß–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {chat_title}\n"
        f"Chat ID: {chat_id}\n\n"
        "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ —ç—Ç–æ—Ç —á–∞—Ç."
    )

    logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–∞—Ç {chat_title} ({chat_id})")


async def show_info(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.effective_user.username not in ALLOWED_USERS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return

    config = load_config()
    chat_id = config.get("chat_id")

    if chat_id:
        status = f"‚úÖ –ß–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (ID: {chat_id})"
    else:
        status = "‚ùå –ß–∞—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /setchat"

    await update.message.reply_text(
        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:\n\n"
        f"{status}\n"
        f"–î–Ω–∏ –ø–ª–∞–Ω—ë—Ä–æ–∫: –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, —Å—Ä–µ–¥–∞, –ø—è—Ç–Ω–∏—Ü–∞\n"
        f"–í—Ä–µ–º—è: {MEETING_TIME['hour']:02d}:{MEETING_TIME['minute']:02d} –ø–æ –ú–°–ö\n"
        f"–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {', '.join(ALLOWED_USERS)}"
    )


async def test_reminder(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.effective_user.username not in ALLOWED_USERS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return

    config = load_config()
    if not config.get("chat_id"):
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–∞—Ç –∫–æ–º–∞–Ω–¥–æ–π /setchat")
        return

    context.application.job_queue.run_once(send_reminder, 5, chat_id=config["chat_id"])

    await update.message.reply_text("‚è≥ –¢–µ—Å—Ç–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")


async def test_now(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    if update.effective_user.username not in ALLOWED_USERS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return

    config = load_config()
    if not config.get("chat_id"):
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–∞—Ç –∫–æ–º–∞–Ω–¥–æ–π /setchat")
        return

    await update.message.reply_text("üöÄ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å...")

    class DummyJob:
        def __init__(self):
            self.name = "manual_test_job"

    context.job = DummyJob()

    await send_reminder(context)


def calculate_next_reminder() -> datetime:
    now = datetime.now(TIMEZONE)
    current_weekday = now.weekday()

    if current_weekday in MEETING_DAYS:
        reminder_time = now.replace(
            hour=MEETING_TIME['hour'],
            minute=MEETING_TIME['minute'],
            second=0,
            microsecond=0
        )
        if now < reminder_time:
            return reminder_time

    days_ahead = 1
    while True:
        next_day = now + timedelta(days=days_ahead)
        if next_day.weekday() in MEETING_DAYS:
            return next_day.replace(
                hour=MEETING_TIME['hour'],
                minute=MEETING_TIME['minute'],
                second=0,
                microsecond=0
            )
        days_ahead += 1


async def schedule_next_reminder(context: ContextTypes.DEFAULT_TYPE) -> None:
    next_time = calculate_next_reminder()
    config = load_config()
    chat_id = config.get("chat_id")

    if not chat_id:
        logger.warning("Chat ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–æ")
        return

    now = datetime.now(TIMEZONE)
    delay = (next_time - now).total_seconds()

    if delay > 0:
        context.application.job_queue.run_once(
            send_reminder,
            delay,
            chat_id=chat_id,
            name=f"meeting_reminder_{next_time.strftime('%Y%m%d_%H%M')}"
        )

        context.application.job_queue.run_once(
            schedule_next_reminder,
            delay + 60,
            chat_id=chat_id
        )

        logger.info(f"–°–ª–µ–¥—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ {next_time}")


def main() -> None:
    if not TOKEN:
        logger.error("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return

    application = Application.builder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("setchat", set_chat))
    application.add_handler(CommandHandler("info", show_info))
    application.add_handler(CommandHandler("test", test_reminder))
    application.add_handler(CommandHandler("testnow", test_now))

    application.add_handler(CallbackQueryHandler(cancel_meeting_callback, pattern="^cancel_meeting$"))
    application.add_handler(CallbackQueryHandler(reason_callback, pattern="^reason_"))

    application.job_queue.run_once(
        lambda context: schedule_next_reminder(context),
        2
    )

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == "__main__":
    main()
